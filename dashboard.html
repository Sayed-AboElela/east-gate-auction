<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مخطط المزاد</title>
  <link rel="icon" type="image/svg+xml" href="assets/images/compass.svg" />
  <script src="assets/js/d3@v7.js"></script>
  <link rel="stylesheet" href="assets/css/main.css" />
</head>

<body dir="rtl">
  <style>
    section.tools {
      scale: 1.5;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 2em;

      .input-container input,
      .input-container select {
        width: 70px;
      }

      .input-container label {
        display: inline-block;
        width: 100px;
      }

    }

    .confirm-container {
      border-radius: 10px;
      display: flex;
      align-items: center;
      gap: 1em;

      .confirm-description {
        margin: 0;
        width: 15ch;
      }

      .confirm-btn {
        font-weight: bold;
        border: none;
        color: #fff;
        background-image: linear-gradient(30deg, #2bf35d, #00b637);
        border-radius: 20px;
        background-size: 100% auto;
        font-family: inherit;
        padding: 0.3em 1.5em;
        background-position: right center;
        background-size: 200% auto;
        cursor: pointer;

        &:not(:disabled):active {
          background-image: linear-gradient(-30deg, #2bf35d, #00b637);
        }

        &:not(:disabled) {
          -webkit-animation: ring-pulse 1.5s infinite;
          animation: ring-pulse 1.5s infinite;
        }

        &:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      }

      @keyframes ring-pulse {
        0% {
          box-shadow: 0 0 0 0 #05bada66;
        }

        70% {
          box-shadow: 0 0 0 10px rgb(218 103 68 / 0%);
        }

        100% {
          box-shadow: 0 0 0 0 rgb(218 103 68 / 0%);
        }
      }
    }

    .reset-btn {
      background-color: transparent;
      border: none;
      color: gray;
      cursor: pointer;

      &:hover {
        text-decoration: underline;
        color: red;
      }
    }
  </style>

  <body dir="rtl">
    <main>
      <div class="map-container">
        <div class="compass-container">
          <img src="assets/images/compass.svg" alt="compass" />
        </div>
      </div>
      <div class="details-outer">
        <section class="tools">
          <div class="input-container">
            <label>الواجهة</label>
            <select id="interface-input">
              <option value="north">شمالية</option>
              <option value="south">جنوبية</option>
              <option value="east">شرقية</option>
              <option value="west">غربية</option>
            </select>
          </div>
          <div class="input-container">
            <label>عدد القطع</label>
            <input type="number" id="units-count-input" value="1" />
          </div>
          <div class="input-container">
            <label>رقم المضرب</label>
            <input type="number" id="madrab-num-input" value="55" />
          </div>
          <div class="input-container">
            <label>سعر المتر</label>
            <input type="number" id="meter-price-input" value="1000" />
          </div>
          <div class="input-container">
            <label>مساحة القطعة</label>
            <input type="number" id="unit-area-input" value="375" />
          </div>
          <div class="confirm-container">
            <p class="confirm-description"></p>
            <button class="confirm-btn">تأكيد</button>
          </div>
          <div class="confirm-container">
            <button class="reset-btn">حذف التعديلات واسترجاع الوضع الأول؟</button>
          </div>
        </section>
      </div>
    </main>

    <script src="assets/js/main.js"></script>
    <script>
      const resetBtn = document.querySelector(".reset-btn");
      const confirmBtn = document.querySelector(".confirm-btn");
      const interfaceInput = document.getElementById("interface-input");
      const unitsCountInput = document.getElementById("units-count-input");
      const madrabNumInput = document.getElementById("madrab-num-input");
      const meterPriceInput = document.getElementById("meter-price-input");
      const unitAreaInput = document.getElementById("unit-area-input");
      const textElm = document.querySelector(".confirm-description");

      const southUnits = [
        107, 44, 74, 135, 129, 111, 110, 109, 108, 106, 97, 96, 95, 22, 21, 20, 19, 18, 17, 16, 15, 14, 105, 13, 12, 11, 10, 87, 86, 85, 84, 83, 82, 81, 80, 79, 78, 77, 76, 75, 73, 72, 55, 54, 53, 52, 51, 50, 49, 48, 47, 46, 45, 43, 42, 41, 134, 133, 132, 131, 130, 128, 127, 126, 125, 124, 40, 39
      ];

      let units;
      setupMap({
        values: loadValues,
        mapData: loadMapData,
        unitClicked: (unit) => {
          const unitNum = Number.parseInt(unit.node().id.slice("unit-".length));
          if (unitNum >= 136 && unitNum <= 148) {
            interfaceInput.value = "east";
          } else if (unitNum >= 149 && unitNum <= 160) {
            interfaceInput.value = "west";
          } else if (southUnits.includes(unitNum)) {
            interfaceInput.value = "south";
          } else {
            interfaceInput.value = "north";
          }
          saveValues();
        }
      }).then(({ units: _units }) => {
        units = _units;
      });

      function saveValues() {
        const interface_ = interfaceInput.value;
        const unitsCount = Number.parseInt(unitsCountInput.value);
        const madrabNum = Number.parseInt(madrabNumInput.value);
        const meterPrice = Number.parseInt(meterPriceInput.value);
        const unitArea = Number.parseInt(unitAreaInput.value);

        saveData("values", JSON.stringify({
          interface: interface_,
          unitsCount,
          madrabNum,
          meterPrice,
          unitArea,
        }));
      }

      function loadValues() {
        try {
          const parsed = JSON.parse(localStorage.getItem("values"));
          if (parsed) {
            interfaceInput.value = parsed.interface;
            unitsCountInput.value = parsed.unitsCount;
            madrabNumInput.value = parsed.madrabNum;
            meterPriceInput.value = parsed.meterPrice;
            unitAreaInput.value = parsed.unitArea;
          }
        } catch {
          localStorage.removeItem("values");
        }
      }

      function loadMapData() {
        const data = JSON.parse(localStorage.getItem("map-data"));
        const selectedCnt = data.filter((d) => d === "selected").length;
        textElm.textContent = `عدد القطع المحددة: ${selectedCnt}`;
        unitsCountInput.value = selectedCnt;
        if (selectedCnt) confirmBtn.disabled = false;
        else confirmBtn.disabled = true;
      }

      interfaceInput.addEventListener("change", saveValues);
      unitsCountInput.addEventListener("change", saveValues);
      madrabNumInput.addEventListener("change", saveValues);
      meterPriceInput.addEventListener("change", saveValues);
      unitAreaInput.addEventListener("change", saveValues);
      unitsCountInput.addEventListener("keyup", saveValues);
      madrabNumInput.addEventListener("keyup", saveValues);
      meterPriceInput.addEventListener("keyup", saveValues);
      unitAreaInput.addEventListener("keyup", saveValues);

      confirmBtn.addEventListener("click", () => {
        const data = JSON.parse(localStorage.getItem("map-data"));
        const newData = data.map(d => d === "selected" ? "completed" : d);
        units?.each(function (d) { this.classList.remove(d); }).data(newData).each(function (d) { this.classList.add(d); });
        saveData("map-data", JSON.stringify(newData));
        loadMapData();
        saveValues();
      });

      resetBtn.addEventListener("click", () => {
        if (confirm("هل أنت متأكد من حذف التعديلات؟")) {
          localStorage.removeItem("map-data");
          localStorage.removeItem("values");
          localStorage.removeItem("transform");
          window.location.reload();
        }
      });
    </script>
  </body>

</html>